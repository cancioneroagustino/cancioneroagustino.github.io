<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>PROGRAMA DE MISA</title>
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
<meta name="robots" content="noindex">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<script src="./scripts/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/cancionero.css">
  <script src="https://www.cancionerocatolico.cl/scripts/jquery.min.js"></script>
  <script src="https://www.cancionerocatolico.cl/scripts/Sortable.min.js"></script>
</head>

<body>
  <div id="nav-placeholder"></div>
<script>
$(function(){
  $("#nav-placeholder").load("navbar.html");
});
</script>

  <main class="container mt-4 text-center">
    <h1 class="titulo">CREAR PROGRAMA DE MISA</h1>

    <!-- Formulario 1: Selección de sección -->
    <form id="form-seccion" class="mt-4">
      <label for="seccion-select">Sección:</label>
      <select id="seccion-select" class="form-select" onchange="actualizarListaCanciones()"></select>
    </form>

    <!-- Formulario 2: Selección de canción -->
    <form id="form-cancion" class="mt-3">
      <label for="cancion-select">Canción:</label>
      <select id="cancion-select" class="form-select"></select>
    <div class="d-flex justify-content-evenly">
      <button type="button" class="btn btn-outline-primary mt-2" onclick="agregarCancion()">Agregar</button>
      <button id="limpiar-programa" class="btn btn-outline-primary mt-2">Limpiar listado</button>
  </div>
    </form>

    <hr>

<!-- Listado del programa -->
    <ul id="programa-lista" class="list-unstyled mt-3"></ul>

<div class="mt-4">
    <button id="programa-full" class="btn btn-outline-primary mb-3">Programa full (con acordes)</button>
    <button id="programa-acordes" class="btn btn-outline-primary mb-3">Lista canciones (con acordes)</button>
    <button id="programa-texto" class="btn btn-outline-primary mb-3">Lista canciones (sólo texto)</button>
    <button id="programa-proyector" class="btn btn-outline-primary mb-3">Proyectar letra</button>
    <button id="compartir-programa" class="btn btn-outline-primary mb-3">Compartir listado</button>
  </div>

  <div class="mb-5"></div>
  </main>

  <script src="scripts/canciones.js"></script>

  <script>
    let programa = JSON.parse(localStorage.getItem("programaMisa")) || [];

    /* --- Poblar el select de secciones --- */
    const seccionSelect = document.getElementById("seccion-select");
    for (const seccion in canciones) {
      const option = document.createElement("option");
      option.value = seccion;
      option.textContent = seccion;
      seccionSelect.appendChild(option);
      seccionSelect.dispatchEvent(new Event("change"));
    }

    /* --- Actualizar canciones según sección --- */
    function actualizarListaCanciones() {
      const seccion = seccionSelect.value;
      const selectCancion = document.getElementById("cancion-select");
      selectCancion.innerHTML = "";

      for (const nombre in canciones[seccion]) {
        const option = document.createElement("option");
        option.value = nombre;
        option.textContent = nombre;
        selectCancion.appendChild(option);
      }
    }

    /* --- Transposición de tono (respeta 'm') --- */
    function transponerTono(tono, semitonos) {
      const tonos = ["DO","DO#","RE","MIb","MI","FA","FA#","SOL","LAb","LA","SIb","SI"];
      const esMenor = tono.endsWith("m");
      const base = esMenor ? tono.slice(0, -1) : tono;
      const idx = tonos.indexOf(base);
      if (idx === -1) return tono;
      const nuevo = tonos[(idx + semitonos + 12) % 12];
      return esMenor ? nuevo + "m" : nuevo;
    }

    /* --- Agregar canción al programa --- */
    function agregarCancion() {
      const seccion = seccionSelect.value;
      const nombre = document.getElementById("cancion-select").value;
      const datos = canciones[seccion][nombre];
      programa.push({
        seccion: seccion,
        nombre: nombre,
        cancion: datos.ruta,
        tono: datos.tono
      });
      mostrarPrograma();
      guardarPrograma();
    }

    /* --- Guardar programa --- */
    function guardarPrograma() {
      localStorage.setItem("programaMisa", JSON.stringify(programa));
    }

    /* --- Mostrar programa en pantalla --- */
    function mostrarPrograma() {
      const lista = document.getElementById("programa-lista");
      lista.innerHTML = "";

      programa.forEach((item, index) => {
        const li = document.createElement("li");
        li.classList.add("programa-item");
        li.textContent = `${item.seccion}: ${item.nombre} `;

       const buttonGroup = document.createElement('div');
        buttonGroup.className = 'd-inline-flex justify-content-end btn-group';

        // Control de tono
        const contTono = document.createElement("span");
        contTono.classList.add("control-tono");

        const btnDown = document.createElement("span");
        btnDown.textContent = "◀";
        btnDown.classList.add("flecha-tono");
        btnDown.onclick = () => {
          item.tono = transponerTono(item.tono, -1);
          spanTono.textContent = item.tono;
          guardarPrograma();
        };

        const spanTono = document.createElement("span");
        spanTono.classList.add("tono-actual");
        spanTono.textContent = item.tono;

        const btnUp = document.createElement("span");
        btnUp.textContent = "▶";
        btnUp.classList.add("flecha-tono");
        btnUp.onclick = () => {
          item.tono = transponerTono(item.tono, +1);
          spanTono.textContent = item.tono;
          guardarPrograma();
        };

        contTono.appendChild(btnDown);
        contTono.appendChild(spanTono);
        contTono.appendChild(btnUp);
        buttonGroup.appendChild(contTono);

        // Botón eliminar
        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "✕";
        btnEliminar.className = 'btn btn-outline-danger btn-sm';
        btnEliminar.onclick = () => {
          programa.splice(index, 1);
          mostrarPrograma();
          guardarPrograma();
        };
        buttonGroup.appendChild(btnEliminar);

        li.appendChild(buttonGroup);
        lista.appendChild(li);
      });
    }

    /* --- Inicialización de Arrastre --- */
function inicializarSortable() {
  const lista = document.getElementById("programa-lista");
  
  Sortable.create(lista, {
    animation: 150, // Duración de la animación en ms
    ghostClass: 'sortable-ghost', // Clase cuando se arrastra
    onEnd: function (evt) {
      // evt.oldIndex es la posición original
      // evt.newIndex es la nueva posición
      
      // Reordenar el array 'programa' basado en el movimiento
      const itemMovido = programa.splice(evt.oldIndex, 1)[0];
      programa.splice(evt.newIndex, 0, itemMovido);
      
      // Guardar el nuevo orden y refrescar para actualizar los índices de los botones
      guardarPrograma();
      mostrarPrograma(); 
    },
  });
}

/* --- Actualiza tu window.addEventListener final --- */
window.addEventListener("DOMContentLoaded", () => {
  actualizarListaCanciones();
  mostrarPrograma();
  cargarProgramaDesdeURL();
  inicializarSortable(); // <--- Activar el arrastre aquí
});

    /* --- Limpiar programa --- */
    document.getElementById("limpiar-programa").addEventListener("click", () => {
       {
        programa = [];
        guardarPrograma();
        mostrarPrograma();
      }
    });

/* --- Compartir programa (genera URL con tonos) --- */
document.getElementById("compartir-programa").addEventListener("click", () => {
  const params = programa.map(item =>
    `${encodeURIComponent(item.seccion)}=${encodeURIComponent(item.nombre)}~${encodeURIComponent(item.tono)}`
  ).join("&");
  const url = `${window.location.origin}${window.location.pathname}?${params}`;
  navigator.clipboard.writeText(url);
  alert("Enlace copiado al portapapeles:\n\n" + url);
});

/* --- Cargar programa desde URL (con tono incluido) --- */
function cargarProgramaDesdeURL() {
  const params = new URLSearchParams(window.location.search);
  if ([...params].length === 0) return;

  programa = [];
  for (const [seccion, valor] of params.entries()) {
    const [nombre, tono] = valor.split("~");
    if (canciones[seccion] && canciones[seccion][nombre]) {
      const datos = canciones[seccion][nombre];
      programa.push({
        seccion: seccion,
        nombre: nombre,
        cancion: datos.ruta,
        tono: tono || datos.tono   // usa el del enlace o el por defecto
      });
    }
  }
  guardarPrograma();
  mostrarPrograma();
}

    /* --- Botones de salida --- */
    document.getElementById("programa-full").addEventListener("click", () => {
      guardarPrograma();
      window.location.href = "programa-full.html";
    });
    document.getElementById("programa-acordes").addEventListener("click", () => {
      guardarPrograma();
      window.location.href = "programa-acordes.html";
    });
    document.getElementById("programa-texto").addEventListener("click", () => {
      guardarPrograma();
      window.location.href = "programa-texto.html";
    });
    document.getElementById("programa-proyector").addEventListener("click", () => {
  guardarPrograma();
  window.location.href = "proyector.html";
});


        // --- Auto redirección a programa-texto si se pide ?autoTexto=1 ---
  window.addEventListener('load', function(){
  if (window.location.hash === '#autoTexto=1') {
    // Espera un instante para que se cargue el programa desde la URL
    setTimeout(() => {
      document.getElementById('programa-texto').click();
    }, 50); // 800 ms suele ser suficiente;
  }
});

    /* --- Inicialización --- */
    window.addEventListener("DOMContentLoaded", () => {
      actualizarListaCanciones();
      mostrarPrograma();
      cargarProgramaDesdeURL();
    });
  </script>
</body>
</html>