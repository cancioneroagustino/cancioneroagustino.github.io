<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Programa con Acordes - Cancionero Católico</title>
  <meta name="robots" content="noindex">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="css/cancionero.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
</head>

<body>
  <div id="nav-placeholder"></div>
  <script>
    $(function(){
      $("#nav-placeholder").load("navbar.html");
    });
  </script>

  <div id="programa-acordes-container" class="d-flex flex-column col-lg-6 justify-content-center align-items-lg-center mt-5"></div>

  <script>
  // --- Lee el programa desde localStorage ---
  const programa = JSON.parse(localStorage.getItem('programaMisa'));
  if (!programa || programa.length === 0) {
    alert('No hay un programa de misa guardado.');
    window.location.href = 'crear-programa.html';
  }

  // --- Helper: cargar un script solo una vez ---
  function cargarScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Error cargando ' + src));
      document.head.appendChild(s);
    });
  }

  // --- Cargar y obtener title + contenido del <pre id="letra"> (sin modificar) ---
  async function fetchCancionData(ruta) {
    const res = await fetch(ruta);
    if (!res.ok) throw new Error('Error al cargar ' + ruta);
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');

    // Título
    const titleEl = doc.querySelector('title');
    const title = titleEl ? titleEl.innerText : 'Sin título';

    // Pre con id="letra" (extraemos su innerHTML y su data-key)
    const pre = doc.querySelector('pre#letra');
    if (!pre) throw new Error('No se encontró <pre id="letra"> en ' + ruta);

    const preInner = pre.innerHTML;
    const dataKey = pre.getAttribute('data-key') || '';

    return { title, preInner, dataKey };
  }

  // --- Insertar canción en el DOM y, si corresponde, transponer usando plugin ---
async function insertarYCambiarSiCorresponde(container, ruta, tonoDeseado) {
  try {
    const { title, preInner, dataKey: tonoOriginal } = await fetchCancionData(ruta);

    // Crear la columna bootstrap
    const col = document.createElement("div");
    col.className = "col-12 col-md-8 col-lg-4";

    // Contenedor de la canción
    const article = document.createElement("div");
    article.className = "d-flex justify-content-center cancion-content mb-4";

    // Título
    const h2 = document.createElement("h2");
    h2.textContent = title;
    h2.className = "col-12 text-center";
    article.appendChild(h2);

    // Pre con la letra
    const pre = document.createElement("pre");
    pre.className = "letra";
    pre.setAttribute("data-key", tonoOriginal);
    pre.innerHTML = preInner;
    article.appendChild(pre);

    col.appendChild(article);
    container.appendChild(col);

    // Determinar si usar versión mayor o menor según el tono solicitado o el original
    const usarMenor = /m$/i.test(tonoDeseado || tonoOriginal);
    const script = usarMenor
      ? "scripts/cancioneromenor.js"
      : "scripts/cancionero.js";

    // Asegurar que jQuery esté cargado
    await cargarScript("https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js");

    // Cargar el script adecuado
    await cargarScript(script);

    // Esperar un momento para que el plugin se registre
    await new Promise((r) => setTimeout(r, 100));

    // Inicializar el plugin
    if (window.jQuery && typeof jQuery.fn.transpose === "function") {
      const $pre = jQuery(pre);
      $pre.transpose();

      // Aplicar cambio de tono si es distinto
      if (tonoDeseado && tonoDeseado !== tonoOriginal) {
        const claveObjetivo = tonoDeseado.replace(/m$/i, "");
        const $keysBlock = $pre.prev(".transpose-keys");
        const $link = $keysBlock
          .find("a")
          .filter(function () {
            return (
              jQuery(this).text().toUpperCase() ===
              claveObjetivo.toUpperCase()
            );
          })
          .first();
        if ($link.length) {
          $link.trigger("click");
        } else {
          console.warn(
            "No se encontró enlace de tono",
            claveObjetivo,
            "para",
            ruta
          );
        }
      }
    } else {
      console.warn("⚠️ Plugin transpose no disponible aún:", script);
    }
  } catch (err) {
  console.warn("⚠️ Error menor o falta de tonalidad en:", ruta, err.message);
  // No mostramos nada visual si el contenido ya se insertó correctamente.
  // Sólo dejamos el log en consola para depuración.
}
}

  // --- Mostrar todas las canciones juntas (modo "acordes") ---
  async function mostrarProgramaConAcordes() {
    const container = document.getElementById('programa-acordes-container');

    // Iteramos en orden y procesamos cada canción
    for (const item of programa) {
      // item tiene: {seccion, nombre, cancion (ruta), tono}
      await insertarYCambiarSiCorresponde(container, item.cancion, item.tono);
    }
  }

  // Ejecutar
  mostrarProgramaConAcordes();
  </script>
</body>
</html>