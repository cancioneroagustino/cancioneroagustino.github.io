<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Programa con Acordes - Cancionero Católico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<script src="./scripts/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/cancionero.css">
<script src="https://www.cancionerocatolico.cl/scripts/jquery.min.js"></script>
</head>

<body>
  <div id="nav-placeholder"></div>
  <script>
    $(function(){
      $("#nav-placeholder").load("navbar.html");
    });
  </script>

  <div id="programa-acordes-container" class="d-flex justify-content-center mt-5"></div>

  <script>
  // --- Lee el programa desde localStorage ---
  const programa = JSON.parse(localStorage.getItem('programaMisa'));
  if (!programa || programa.length === 0) {
    alert('No hay un programa de misa guardado.');
    window.location.href = 'crear-programa.html';
  }

  // --- Helper: cargar un script solo una vez ---
  function cargarScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Error cargando ' + src));
      document.head.appendChild(s);
    });
  }

  // --- Cargar y obtener title + contenido del <pre id="letra"> (sin modificar) ---
  async function fetchCancionData(ruta) {
    const res = await fetch(ruta);
    if (!res.ok) throw new Error('Error al cargar ' + ruta);
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');

    // Título
    const titleEl = doc.querySelector('title');
    const title = titleEl ? titleEl.innerText : 'Sin título';

    // Pre con id="letra"
    const pre = doc.querySelector('pre#letra');
    if (!pre) throw new Error('No se encontró <pre id="letra"> en ' + ruta);

    const preInner = pre.innerHTML;
    const dataKey = pre.getAttribute('data-key') || '';

    return { title, preInner, dataKey };
  }

  // --- Insertar canción en el DOM y aplicar transposición ---
  async function insertarYCambiarSiCorresponde(container, ruta, tonoDeseado) {
    try {
      const { title, preInner, dataKey: tonoOriginal } = await fetchCancionData(ruta);

      // Crear contenedor visual para la canción
      const article = document.createElement('div');
      article.className = 'cancion-content mb-4';

      // Título
      const h2 = document.createElement('h2');
      h2.textContent = title;
      article.appendChild(h2);

      // Pre con la letra
      const pre = document.createElement('pre');
      pre.className = 'letra';
      pre.setAttribute('data-key', tonoOriginal);
      pre.innerHTML = preInner;
      article.appendChild(pre);

      container.appendChild(article);

      // Asegurar jQuery
      await cargarScript("https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js");

      // Cargar el nuevo plugin unificado
      await cargarScript("scripts/transpositor.js");

      // Esperar a que esté disponible
      await new Promise((r) => setTimeout(r, 100));

      // Inicializar plugin
      if (window.jQuery && typeof jQuery.fn.transpose === "function") {
        const $pre = jQuery(pre);
        $pre.transpose();

        // Aplicar cambio de tono si es distinto
        if (tonoDeseado && tonoDeseado !== tonoOriginal) {
          const claveObjetivo = tonoDeseado.replace(/m$/i, "");
          const $keysBlock = $pre.prev(".transpose-keys");
          const $link = $keysBlock
            .find("a")
            .filter(function () {
              return (
                jQuery(this).text().toUpperCase() ===
                claveObjetivo.toUpperCase()
              );
            })
            .first();
          if ($link.length) {
            $link.trigger("click");
            $pre.prev(".transpose-keys").hide(); // oculta los botones
          } else {
            console.warn("No se encontró enlace de tono", claveObjetivo, "para", ruta);
          }
        } else {
          $pre.prev(".transpose-keys").hide();
        }
      } else {
        console.warn("⚠️ Plugin transpose no disponible aún");
      }
    } catch (err) {
      console.error(err);
      const errDiv = document.createElement('div');
      errDiv.className = 'cancion-content mb-4';
      errDiv.innerHTML = `<h2>Error</h2><p>Error al cargar la canción ${ruta}. ${err.message}</p>`;
      container.appendChild(errDiv);
    }
  }

  // --- Mostrar todas las canciones juntas (modo acordes) ---
  async function mostrarProgramaConAcordes() {
    const container = document.getElementById('programa-acordes-container');
    for (const item of programa) {
      await insertarYCambiarSiCorresponde(container, item.cancion, item.tono);
    }
  }

  // Ejecutar
  mostrarProgramaConAcordes();
  </script>
</body>
</html>
