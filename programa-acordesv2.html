<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Programa de misa - Cancionero Católico</title>
  <meta name="robots" content="noindex">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="css/cancionero.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="scripts/cancionero.js"></script>
  <script src="scripts/cancioneromenor.js"></script>
</head>

<body>
  <div id="nav-placeholder"></div>
  <script>
    $(function(){
      $("#nav-placeholder").load("navbar.html");
    });
  </script>

  <div id="programa-completo-container" class="d-flex justify-content-center mt-5"></div>

  <script>
  // --- Recuperar el programa desde localStorage ---
  const programa = JSON.parse(localStorage.getItem('programaMisa'));
  if (!programa) {
    alert('No hay un programa de misa guardado.');
    window.location.href = 'crear-programa.html';
  }

  // --- Cargar dinámicamente el script correcto (mayor o menor) ---
  function cargarScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement("script");
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }


  // --- Cargar y procesar una canción ---
  async function cargarCancion(ruta, tonoDestino) {
    try {
      const response = await fetch(ruta);
      if (!response.ok) throw new Error('Error al cargar la canción');
      const contenido = await response.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(contenido, 'text/html');
       const preContent = doc.querySelector('pre').innerHTML;
      const tonoOriginal = pre ? pre.dataset.key : null;
      const title = doc.querySelector('title').innerText;

      // Transponer si corresponde
      if (tonoDestino && tonoOriginal && tonoDestino !== tonoOriginal) {
        pre.innerHTML = transponerAcordes(pre.innerHTML, tonoOriginal.replace('m',''), tonoDestino.replace('m',''));
        pre.dataset.key = tonoDestino;
      }

      return `<h2>${title}</h2><pre class="lh-base">${pre.innerHTML}</pre>`;
    } catch (error) {
      console.error('Error:', error);
      return '<p>Error al cargar la canción.</p>';
    }
  }

  // --- Mostrar todas las canciones juntas ---
  async function mostrarProgramaCompleto() {
    const container = document.getElementById('programa-completo-container');
    let contenidoTotal = "";

    for (const item of programa) {
      const usarMenor = item.tono && item.tono.endsWith("m");
      const script = usarMenor ? "scripts/cancioneromenor.js" : "scripts/cancionero.js";
      await cargarScript(script);

      const contenidoCancion = await cargarCancion(item.cancion, item.tono);
      contenidoTotal += `<div class="cancion-content">${contenidoCancion}</div>`;
    }

    container.innerHTML = contenidoTotal;
  }

  mostrarProgramaConAcordes();
  </script>
</body>
</html>