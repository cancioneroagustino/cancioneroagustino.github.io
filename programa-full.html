<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Programa de misa - Cancionero Cat√≥lico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
<meta name="robots" content="noindex">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<script src="./scripts/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/cancionero.css">
<script src="https://www.cancionerocatolico.cl/scripts/jquery.min.js"></script>
</head>

<body>
  <div id="nav-placeholder"></div>
  <script>
    $(function(){
      $("#nav-placeholder").load("navbar.html");
    });
  </script> 

  <div class="navigation-buttons">
    <button id="anterior" class="btn btn-outline-primary">Anterior</button>
    <button id="siguiente" class="btn btn-outline-primary">Siguiente</button>
  </div>

  <div id="programa-container"></div>

<script>
  const programa = JSON.parse(localStorage.getItem('programaMisa'));
  if (!programa) {
    alert('No hay un programa de misa guardado.');
    window.location.href = 'crear-programa.html';
  }

  const canciones = programa.map(item => item.cancion);
  let currentIndex = 0;

  async function cargarCancion(ruta) {
    try {
      console.log(`Cargando canci√≥n desde: ${ruta}`);
      const response = await fetch(ruta);
      if (!response.ok) {
        throw new Error('Error al cargar la canci√≥n');
      }
      const contenido = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(contenido, 'text/html');
      const bodyContent = doc.querySelector('body').innerHTML;

      // Crear un contenedor temporal para manipular el contenido
      const tempContainer = document.createElement('div');
      tempContainer.innerHTML = bodyContent;

      // Eliminar el navbar si est√° presente
      const navbar = tempContainer.querySelector('#nav-placeholder');
      if (navbar) {
        navbar.remove();
      }

      document.getElementById('programa-container').innerHTML = tempContainer.innerHTML;

      // Ajustar rutas de los scripts y ejecutarlos
      const scripts = tempContainer.querySelectorAll('script');
      scripts.forEach(script => {
        const newScript = document.createElement('script');
        if (script.src) {
          let src = script.src;
          if (src.startsWith('../')) src = src.replace('../', '/');
          newScript.src = src;
        } else {
          newScript.textContent = script.textContent;
        }
        document.body.appendChild(newScript);
      });

      // Esperar un momento para que el script de transposici√≥n cargue y cree los botones
      setTimeout(() => {
        aplicarTono(programa[currentIndex]);
      }, 500);

    } catch (error) {
      console.error('Error:', error);
      document.getElementById('programa-container').innerHTML =
        '<p>Error al cargar la canci√≥n. Int√©ntalo de nuevo m√°s tarde.</p>';
    }
  }

  // üîπ Nueva funci√≥n: aplicar el tono seg√∫n el programa
  function aplicarTono(item) {
    try {
      const pre = document.querySelector('#letra');
      if (!pre) return;

      const tonoOriginal = pre.getAttribute('data-key')?.trim() || '';
      const tonoDeseado = item.tono?.trim() || '';

      if (!tonoDeseado || tonoDeseado === tonoOriginal) return;

      console.log(`Aplicando transposici√≥n de ${tonoOriginal} ‚Üí ${tonoDeseado}`);

      // Asegurar que el plugin existe
      if (typeof $ === 'undefined' || typeof $.fn.transpose !== 'function') {
        console.warn('Plugin transpose no disponible a√∫n.');
        return;
      }

      const $pre = $(pre);
      if (!$pre.prev('.transpose-keys').length) {
        // inicializa la interfaz del plugin si a√∫n no est√° creada
        $pre.transpose();
      }

      // Buscar el enlace del tono deseado
      const claveObjetivo = tonoDeseado.replace(/m$/i, '');
      const $keysBlock = $pre.prev('.transpose-keys');
      const $link = $keysBlock.find('a').filter(function () {
        return $(this).text().toUpperCase() === claveObjetivo.toUpperCase();
      }).first();

      if ($link.length) {
        $link.trigger('click');
      } else {
        console.warn('No se encontr√≥ el tono deseado en los botones del plugin.');
      }
    } catch (err) {
      console.error('Error al aplicar tono:', err);
    }
  }

  function mostrarCancion(index) {
    currentIndex = index;
    cargarCancion(programa[index].cancion);
  }

  document.getElementById('anterior').addEventListener('click', function () {
    if (currentIndex > 0) mostrarCancion(currentIndex - 1);
  });

  document.getElementById('siguiente').addEventListener('click', function () {
    if (currentIndex < programa.length - 1) mostrarCancion(currentIndex + 1);
  });

  // Mostrar la primera canci√≥n al cargar la p√°gina
  mostrarCancion(currentIndex);
</script>
</body>
</html>