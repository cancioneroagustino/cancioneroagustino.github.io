<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Programa Completo de Misa - Cancionero Católico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
<meta name="robots" content="noindex">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<script src="./scripts/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/cancionero.css">
<script src="https://www.cancionerocatolico.cl/scripts/jquery.min.js"></script>
</head>

<body>
  <div id="nav-placeholder"></div>
  <script>
    $(function(){
      $("#nav-placeholder").load("navbar.html");
    });
  </script> 

  <div id="programa-completo-container" class="d-flex flex-column justify-content-center text-center mt-5"></div>

  <script>
    const programa = JSON.parse(localStorage.getItem('programaMisa'));
    if (!programa) {
      alert('No hay un programa de misa guardado.');
      window.location.href = 'crear-programa.html';
    }

    const canciones = programa.map(item => item.cancion);

    // Función para determinar si una línea es de acordes
    function isChordLine(line) {
  return /(\bDO|\bRE|\bMI|\bFA|\bSOL|\bLA|\bSI)[b#]?|\bCejillo\b|\bIntro\b|\bIntroducción\b/.test(line);
}

    // Función para procesar el contenido de la canción
    function procesarCancion(contenido) {
      const lines = contenido.split('\n');
      let output = '';
      for (let line of lines) {
        if (!isChordLine(line)) {
          output += `<span>${line}</span>\n`;
        }
      }
      return output;
    }

    async function cargarCancion(ruta) {
      try {
        const response = await fetch(ruta);
        if (!response.ok) {
          throw new Error('Error al cargar la canción');
        }
        const contenido = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(contenido, 'text/html');
        const preContent = doc.querySelector('pre').innerHTML;
        const title = doc.querySelector('title').innerText;

        const contenidoProcesado = procesarCancion(preContent);
        return `<h2>${title}</h2><pre class="lh-base">${contenidoProcesado}</pre></div>`;
      } catch (error) {
        console.error('Error:', error);
        return '<p>Error al cargar la canción. Inténtalo de nuevo más tarde.</p>';
      }
    }

    async function mostrarProgramaCompleto() {
      const programaContainer = document.getElementById('programa-completo-container');
      for (const cancion of canciones) {
        const contenidoCancion = await cargarCancion(cancion);
        const divCancion = document.createElement('div');
        divCancion.className = 'cancion-content align-self-lg-center';
        divCancion.innerHTML = contenidoCancion;
        programaContainer.appendChild(divCancion);
      }
    }

    mostrarProgramaCompleto();
  </script>
</body>
</html>