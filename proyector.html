<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Proyector de letras - Cancionero Católico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/cancionero.css">

<style>
:root {
  --bg-color: #ffffff;
  --text-color: #000000;
  --font-size: 6vh;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
}

#configuracion {
  padding: 2rem;
  background-color: var(--bg-color);
  color: var(--text-color);
}

#configuracion .btn {
  color: var(--text-color);
  border-color: var(--text-color);
}

#configuracion .btn:hover {
  background-color: var(--text-color);
  color: var(--bg-color);
}

#pantalla-proyector {
    display: none; /* Se cambia a flex en JS */
    text-align: center;
    width: 100%;
    min-height: 100vh; /* Ocupa toda la altura */
    padding: 5vh 6vw;
    font-family: 'Atkinson Hyperlegible', system-ui, sans-serif;
    font-size: var(--font-size, 6vh);
    line-height: 1.25;
    cursor: pointer; /* Indica que se puede hacer clic */
    user-select: none; /* Evita que se seleccione el texto al hacer clics rápidos */
    touch-action: manipulation; /* Optimiza para toques en móvil */
}


#pantalla-proyector h2 {
  margin-bottom: 6rem;   /* ajusta a gusto */
}


button {
  margin: 0.25rem;
}

.letra-normal {
  margin-bottom: 6rem;
}



#controles-tamano {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 9999;
}

#controles-tamano button {
  display: block;
  margin-bottom: 0.3rem;
  font-size: 0.6rem;
  padding: 0.4rem 0.6rem;
  color: var(--text-color);
  border-color: var(--text-color);
}

/* Clases auxiliares para la proyección por estrofas */
.slide-flex {
    display: flex !important;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.estribillo-destacado {
    font-weight: bold;
}
.titulo-slide {
    display: none;
}

/* Estado base: visible */
#pantalla-proyector > div, 
#pantalla-proyector > h2 {
    transition: opacity 0.2s ease-in-out;
    opacity: 1;
}

/* Clase para el desvanecimiento */
.fade-out {
    opacity: 0 !important;
}

</style>
</head>

<body>


<div id="configuracion" class="container text-center">
  <h1>Proyección de letras</h1>

  <div class="mt-4">
    <h5>Presets</h5>
    <button class="btn btn-outline-secondary" onclick="presetDia1()">Día 1</button>
    <button class="btn btn-outline-secondary" onclick="presetDia2()">Día 2</button>
    <button class="btn btn-outline-secondary" onclick="presetDia3()">Día 3</button>
    <button class="btn btn-outline-secondary" onclick="presetDia4()">Día 4</button>
 </div>
 <div>
    <button class="btn btn-outline-secondary" onclick="presetDia5()">Día 5</button>
    <button class="btn btn-outline-secondary" onclick="presetDia6()">Día 6</button>
    <button class="btn btn-outline-secondary" onclick="presetDia7()">Día 7</button>
    <button class="btn btn-outline-secondary" onclick="presetNoche()">Noche</button>
  </div>

  <div class="mt-4">
    <h5>Colores personalizados</h5>
    <label>Fondo: <input type="color" id="bgColor" value="#ffffff"></label>
    <label class="ms-3">Texto: <input type="color" id="textColor" value="#1a1a1a"></label>
  </div>


  <div class="mt-4">
    <button class="btn btn-outline-secondary btn-lg" onclick="iniciarProyeccion()">Proyectar letras contínuas</button>
    <button class="btn btn-outline-secondary btn-lg" onclick="ProyeccionPorEstrofa()">Proyectar letras por estrofa</button>
  </div>
</div>

<div id="pantalla-proyector"></div>


<script>
// 1. Datos y Estado
const programaMisa = JSON.parse(localStorage.getItem('programaMisa'));
let diapositivas = [];
let indiceActual = 0;

// Función para detectar acordes (CRUCIAL PARA QUE NO DE ERROR)
function isChordLine(line) {
    return /(\bDO|\bRE|\bMI|\bFA|\bSOL|\bLA|\bSI)[b#]?|\bCejillo\b|\bIntro\b/.test(line);
}

// 2. Motor de Carga
async function cargarTodoElPrograma() {
    diapositivas = [];
    if (!programaMisa) return;

    for (const item of programaMisa) {
        try {
            const res = await fetch(item.cancion);
            const html = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const titulo = doc.querySelector('title')?.innerText || "Sin título";
            const pre = doc.querySelector('pre');
            if (!pre) continue;

            const lineas = pre.innerHTML.split('\n');
            let bloques = [];
            let bloqueActual = [];
            let enModoEstribillo = false;

            lineas.forEach((linea) => {
                const limpiaParaAcorde = linea.replace(/<[^>]*>/g, '').trim();
                
                // Ignorar líneas de acordes
                if (isChordLine(limpiaParaAcorde)) return;

                const esVacia = limpiaParaAcorde === "";
                const detectaInicioB = /<b>/i.test(linea);
                const detectaFinB = /<\/b>/i.test(linea);

                // REGLA 1: Si aparece <b>, cerramos lo que hubiera antes y empezamos estribillo
                if (detectaInicioB) {
                    if (bloqueActual.length > 0) {
                        bloques.push({
                            texto: bloqueActual.join('\n').replace(/<[^>]*>/g, '').trim(),
                            esEstribillo: false
                        });
                    }
                    bloqueActual = [linea];
                    enModoEstribillo = true;
                    // Si el </b> está en la misma línea (estribillo de una sola línea)
                    if (detectaFinB) {
                        bloques.push({
                            texto: bloqueActual.join('\n').replace(/<[^>]*>/g, '').trim(),
                            esEstribillo: true
                        });
                        bloqueActual = [];
                        enModoEstribillo = false;
                    }
                    return;
                }

                // REGLA 2: Si aparece </b>, cerramos el estribillo
                if (detectaFinB) {
                    bloqueActual.push(linea);
                    bloques.push({
                        texto: bloqueActual.join('\n').replace(/<[^>]*>/g, '').trim(),
                        esEstribillo: true
                    });
                    bloqueActual = [];
                    enModoEstribillo = false;
                    return;
                }

                // REGLA 3: Línea en blanco separa estrofas normales
                if (esVacia && !enModoEstribillo) {
                    if (bloqueActual.length > 0) {
                        bloques.push({
                            texto: bloqueActual.join('\n').replace(/<[^>]*>/g, '').trim(),
                            esEstribillo: false
                        });
                        bloqueActual = [];
                    }
                    return;
                }

                // Acumulación normal de líneas
                if (!esVacia || enModoEstribillo) {
                    bloqueActual.push(linea);
                }
            });

            // Guardar último bloque residual
            if (bloqueActual.length > 0) {
                bloques.push({
                    texto: bloqueActual.join('\n').replace(/<[^>]*>/g, '').trim(),
                    esEstribillo: enModoEstribillo
                });
            }

            // --- LÓGICA DE INTERCALADO (Misma anterior, ahora con bloques limpios) ---
            diapositivas.push({ tipo: 'titulo', contenido: titulo });

            const estribillos = bloques.filter(b => b.esEstribillo);
            const soloEstrofas = bloques.filter(b => !b.esEstribillo);

            if (estribillos.length === 1 && soloEstrofas.length > 0) {
                const coro = estribillos[0];
                const empiezaConCoro = bloques[0].esEstribillo;

                if (empiezaConCoro) {
                    soloEstrofas.forEach(estrofa => {
                        diapositivas.push({ tipo: 'estrofa', texto: coro.texto, esEstribillo: true });
                        diapositivas.push({ tipo: 'estrofa', texto: estrofa.texto, esEstribillo: false });
                    });
                    diapositivas.push({ tipo: 'estrofa', texto: coro.texto, esEstribillo: true });
                } else {
                    soloEstrofas.forEach(estrofa => {
                        diapositivas.push({ tipo: 'estrofa', texto: estrofa.texto, esEstribillo: false });
                        diapositivas.push({ tipo: 'estrofa', texto: coro.texto, esEstribillo: true });
                    });
                }
            } else {
                bloques.forEach(b => {
                    diapositivas.push({ tipo: 'estrofa', texto: b.texto, esEstribillo: b.esEstribillo });
                });
            }
        } catch (err) { console.error(err); }
    }
    // AÑADIR SLIDE EN BLANCO AL FINAL DE TODO EL PROGRAMA
    diapositivas.push({ tipo: 'fin', contenido: '' });
}

// 3. Visualización
function renderizarSlide() {
    const pantalla = document.getElementById('pantalla-proyector');
    const d = diapositivas[indiceActual];
    if (!d) return;

// Inicia el desvanecimiento (Fade Out)
    pantalla.classList.add('fade-out');

// 2. Esperar a que el texto sea invisible para cambiarlo
    setTimeout(() => {
    if (d.tipo === 'titulo') {
        pantalla.innerHTML = `<h2 style="font-size: 8vh; margin:0;">${d.contenido}</h2>`;
    }
    else if (d.tipo === 'fin') {
        // Pantalla totalmente limpia
        pantalla.innerHTML = ''; 
    }
    else {
        const negrita = d.esEstribillo ? 'font-weight: bold;' : 'font-weight: normal;';
        const textoLimpio = d.texto.replace(/\n/g, '<br>');
        pantalla.innerHTML = `<div style="${negrita} width: 100%;">${textoLimpio}</div>`;
    }

// Quitamos el desvanecimiento para que aparezca el nuevo texto (Fade In)
        pantalla.classList.remove('fade-out');
    }, 200); // 200ms coincide con el tiempo del CSS
}

// 4. Modos de Inicio
async function ProyeccionPorEstrofa() {
    await cargarTodoElPrograma();
    if (diapositivas.length === 0) return alert("No hay letras");
    
    document.getElementById('configuracion').style.display = 'none';
    const p = document.getElementById('pantalla-proyector');
    p.classList.add('slide-flex');
    p.style.display = 'flex';
    indiceActual = 0;
    renderizarSlide();
}

async function iniciarProyeccion() {
    await cargarTodoElPrograma();
    if (diapositivas.length === 0) return alert("No hay letras");

    document.getElementById('configuracion').style.display = 'none';
    const p = document.getElementById('pantalla-proyector');
    
    p.classList.remove('slide-flex');
    p.style.display = 'block';
    p.style.textAlign = 'center';
    
    let htmlFinal = "";
    diapositivas.forEach(d => {
        // Ignoramos el slide de "fin" en el modo continuo para que no añada espacio vacío
        if (d.tipo === 'titulo') {
            htmlFinal += `<h2 style="margin-top:10vh; margin-bottom: 5vh;">${d.contenido}</h2>`;
        } else if (d.tipo === 'estrofa') {
            // Verificamos que d.texto exista
            const textoSeguro = d.texto || "";
            const textoConFormato = d.esEstribillo ? `<b>${textoSeguro}</b>` : textoSeguro;
            const render = textoConFormato.replace(/\n/g, '<br>');
            htmlFinal += `<p class="letra-normal" style="margin-bottom:7vh">${render}</p>`;
        }
    });
    
    p.innerHTML = htmlFinal;
    // Resetear scroll al inicio por si acaso
    window.scrollTo(0,0);
}

// 5. Navegación Universal
function avanzar() {
    if (indiceActual < diapositivas.length - 1) {
        indiceActual++;
        renderizarSlide();
    } else {
        // Solo pregunta si ya estamos en el último slide (el blanco) e intentamos seguir
        if (confirm("¿Finalizar proyección y volver al menú?")) {
            location.reload();
        }
    }
}
function retroceder() {
    if (indiceActual > 0) { indiceActual--; renderizarSlide(); }
}

window.onkeydown = (e) => {
    if (document.getElementById('pantalla-proyector').style.display !== 'none') {
        if (["ArrowRight", "Enter", " "].includes(e.key)) { e.preventDefault(); avanzar(); }
        if (["ArrowLeft", "Backspace"].includes(e.key)) { e.preventDefault(); retroceder(); }
        if (e.key === "Escape") location.reload();
    }
};


// Centralizamos la navegación para evitar saltos dobles
document.getElementById('pantalla-proyector').onclick = (e) => {
    // Si la pantalla no es visible, no hacer nada
    if (document.getElementById('pantalla-proyector').style.display === 'none') return;

    const pantallaAncho = window.innerWidth;
    // Si el clic es en el primer tercio (izquierda), retrocede. Si no, avanza.
    if (e.clientX < pantallaAncho / 3) {
        retroceder();
    } else {
        avanzar();
    }
};

// Quitamos el onmousedown anterior y mantenemos el bloqueo del menú contextual
document.getElementById('pantalla-proyector').onmousedown = null; 
document.getElementById('pantalla-proyector').oncontextmenu = (e) => e.preventDefault();

// Soporte Móvil
document.getElementById('pantalla-proyector').onclick = (e) => {
    if (window.innerWidth > 0) { // Simple check
        if (e.clientX < window.innerWidth / 3) retroceder();
        else avanzar();
    }
};

// 6. Colores y Tamaño

function presetDia1() {
  setColors('#ffffff', '#000000');
}

function presetDia2() {
  setColors('#f2e6a7', '#1a1a1a');
}

function presetDia3() {
  setColors('#dedede', '#1a1a1a');
}

function presetDia4() {
  setColors('#dedede', '#7a1121');
}

function presetDia5() {
  setColors('#4B1F1F', '#F5F5F2');
}

function presetDia6() {
  setColors('#3A2618', '#F5F5F2');
}

function presetDia7() {
  setColors('#3A2618', '#D4B15F');
}

function presetNoche() {
  setColors('#000000', '#ffffff');
}

function setColors(bg, text) {
  document.documentElement.style.setProperty('--bg-color', bg);
  document.documentElement.style.setProperty('--text-color', text);
  document.getElementById('bgColor').value = bg;
  document.getElementById('textColor').value = text;
}

// Definir los elementos antes de usarlos
const inputBg = document.getElementById('bgColor');
const inputText = document.getElementById('textColor');

if(inputBg) {
    inputBg.addEventListener('input', e => {
        document.documentElement.style.setProperty('--bg-color', e.target.value);
    });
}

if(inputText) {
    inputText.addEventListener('input', e => {
        document.documentElement.style.setProperty('--text-color', e.target.value);
    });
}


bgColor.addEventListener('input', e => {
  document.documentElement.style.setProperty('--bg-color', e.target.value);
});

textColor.addEventListener('input', e => {
  document.documentElement.style.setProperty('--text-color', e.target.value);
});

let fontSize = 6;
function aumentarTexto() { fontSize += 0.5; document.documentElement.style.setProperty('--font-size', fontSize + 'vh'); }
function disminuirTexto() { fontSize -= 0.5; document.documentElement.style.setProperty('--font-size', fontSize + 'vh'); }
</script>

<div id="controles-tamano">
  <button class="btn btn-outline-secondary" onclick="aumentarTexto()">A+</button>
  <button class="btn btn-outline-secondary" onclick="disminuirTexto()">A−</button>
</div>

</body>
</html>