<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Proyector de letras - Cancionero Católico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/cancionero.css">

<style>
:root {
  --bg-color: #f2e6a7;
  --text-color: #1a1a1a;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
}

#configuracion {
  padding: 2rem;
}

#pantalla-proyector {
  display: none;
  padding: 5vh 6vw;
  font-family: 'Atkinson Hyperlegible', system-ui, sans-serif;
  font-size: 6vh;
  line-height: 1.25;
  white-space: pre-wrap;
}

.titulo-cancion {
  margin: 3vh 0 1.5vh 0;
  font-weight: 600;
}

button {
  margin: 0.25rem;
}
</style>
</head>

<body>

<div id="configuracion" class="container text-center">
  <h1 class="titulo">Proyección de letras</h1>

  <div class="mt-4">
    <h5>Presets</h5>
    <button class="btn btn-outline-secondary" onclick="presetDia()">Día</button>
    <button class="btn btn-outline-secondary" onclick="presetNoche()">Noche</button>
  </div>

  <div class="mt-4">
    <h5>Colores personalizados</h5>
    <label>Fondo: <input type="color" id="bgColor" value="#f2e6a7"></label>
    <label class="ms-3">Texto: <input type="color" id="textColor" value="#1a1a1a"></label>
  </div>

  <div class="mt-4">
    <button class="btn btn-primary btn-lg" onclick="iniciarProyeccion()">Proyectar letras</button>
  </div>
</div>

<div id="pantalla-proyector"></div>

<script>
const programa = JSON.parse(localStorage.getItem('programaMisa'));

if (!programa || programa.length === 0) {
  alert('No hay un programa de misa cargado.');
  window.location.href = 'crear-programa.html';
}

function presetDia() {
  setColors('#f2e6a7', '#1a1a1a');
}

function presetNoche() {
  setColors('#000000', '#ffffff');
}

function setColors(bg, text) {
  document.documentElement.style.setProperty('--bg-color', bg);
  document.documentElement.style.setProperty('--text-color', text);
  document.getElementById('bgColor').value = bg;
  document.getElementById('textColor').value = text;
}

bgColor.addEventListener('input', e => {
  document.documentElement.style.setProperty('--bg-color', e.target.value);
});

textColor.addEventListener('input', e => {
  document.documentElement.style.setProperty('--text-color', e.target.value);
});

function isChordLine(line) {
  return /(\bDO|\bRE|\bMI|\bFA|\bSOL|\bLA|\bSI)[b#]?/.test(line);
}

function procesarPre(pre) {
  const lines = pre.textContent.split('\n');
  return lines.filter(l => !isChordLine(l)).join('\n');
}

async function cargarCancion(ruta) {
  const response = await fetch(ruta);
  const html = await response.text();
  const doc = new DOMParser().parseFromString(html, 'text/html');

  const titulo = doc.querySelector('h1.titulo')?.innerText || '';
  const pre = doc.querySelector('pre');

  if (!pre) return '';

  let salida = '';
  if (titulo) salida += titulo + '\n\n';
  salida += procesarPre(pre) + '\n\n';
  return salida;
}

async function iniciarProyeccion() {
  document.getElementById('configuracion').style.display = 'none';
  const pantalla = document.getElementById('pantalla-proyector');
  pantalla.style.display = 'block';
  pantalla.textContent = '';

  for (const item of programa) {
    const texto = await cargarCancion(item.cancion);
    pantalla.textContent += texto;
  }
}
</script>

</body>
</html>
