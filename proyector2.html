<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Proyector de letras - Cancionero Católico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/cancionero.css">

<style>
:root {
  --bg-color: #ffffff;
  --text-color: #000000;
  --font-size: 6vh;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
}

#configuracion {
  padding: 2rem;
  background-color: var(--bg-color);
  color: var(--text-color);
}

#configuracion .btn {
  color: var(--text-color);
  border-color: var(--text-color);
}

#configuracion .btn:hover {
  background-color: var(--text-color);
  color: var(--bg-color);
}


.btn-group .btn {
  font-size: 1.1rem;
  padding: 1rem;
}


.btn-group .btn.active,
.btn-group .btn.active:hover,
.btn-group .btn.active:focus {
  background-color: var(--text-color) !important;
  color: var(--bg-color) !important;
  border-color: var(--text-color) !important;
}


.btn-group .btn:active {
  transform: scale(0.98);
}


#pantalla-proyector {
  display: none;
  text-align: center;
  padding: 5vh 6vw;
  font-family: 'Atkinson Hyperlegible', system-ui, sans-serif;
  font-size: var(--font-size, 6vh);
  line-height: 1.25;
  white-space: pre-wrap;
}


#pantalla-proyector h2 {
  margin-bottom: 6rem;   /* ajusta a gusto */
}


button {
  margin: 0.25rem;
}

.letra-normal {
  margin-bottom: 6rem;
}



#controles-tamano {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 9999;
}

#controles-tamano button {
  display: block;
  margin-bottom: 0.3rem;
  font-size: 0.6rem;
  padding: 0.4rem 0.6rem;
  color: var(--text-color);
  border-color: var(--text-color);
}


#controles-proyeccion {
  position: fixed;
  bottom: 1rem;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
  padding: 0 1.5rem;
  z-index: 9999;
}

#controles-proyeccion button {
  font-size: 1.5rem;
  padding: 0.6rem 1.2rem;
  background: transparent;
  color: var(--text-color);
  border: 2px solid var(--text-color);
}


</style>
</head>

<body>


<div id="configuracion" class="container text-center">
  <h1>Proyección de letras</h1>

  <div class="mt-4">
    <h5>Presets</h5>
    <button class="btn btn-outline-secondary" onclick="presetDia1()">Día 1</button>
    <button class="btn btn-outline-secondary" onclick="presetDia2()">Día 2</button>
    <button class="btn btn-outline-secondary" onclick="presetDia3()">Día 3</button>
    <button class="btn btn-outline-secondary" onclick="presetDia4()">Día 4</button>
 </div>
 <div>
    <button class="btn btn-outline-secondary" onclick="presetDia5()">Día 5</button>
    <button class="btn btn-outline-secondary" onclick="presetDia6()">Día 6</button>
    <button class="btn btn-outline-secondary" onclick="presetDia7()">Día 7</button>
    <button class="btn btn-outline-secondary" onclick="presetNoche()">Noche</button>
  </div>

  <div class="mt-4">
    <h5>Colores personalizados</h5>
    <label>Fondo: <input type="color" id="bgColor" value="#ffffff"></label>
    <label class="ms-3">Texto: <input type="color" id="textColor" value="#1a1a1a"></label>
  </div>

  <div class="mt-4">

<div class="mt-4">
  <h5>Modo de proyección</h5>

<div class="mt-4">
  <h5>Contenido</h5>
  <div class="btn-group w-100 mb-3" id="selector-acordes">
    <button class="btn btn-outline-secondary active" data-value="false">
      Solo texto
    </button>
    <button class="btn btn-outline-secondary" data-value="true">
      Texto + acordes
    </button>
  </div>

  <h5>Modo de proyección</h5>
  <div class="btn-group w-100" id="selector-modo">
    <button class="btn btn-outline-secondary active" data-value="false">
      Texto contínuo
    </button>
    <button class="btn btn-outline-secondary" data-value="true">
      Texto por estrofa
    </button>
  </div>
</div>

  <div class="mt-4">
    <button class="btn btn-outline-secondary btn-lg" onclick="proyectarDesdeSelectores()">Proyectar letras</button>
  </div>
</div>

<div id="pantalla-proyector"></div>


<script>
/* ===============================
   CARGA DEL PROGRAMA
================================ */

const programa = JSON.parse(localStorage.getItem('programaMisa'));
if (!programa || programa.length === 0) {
  alert('No hay un programa de misa cargado.');
  window.location.href = 'crear-programa.html';
}


/* ===============================
   PRESETS DE COLOR (SIN CAMBIOS)
================================ */

function presetDia1() { setColors('#ffffff', '#000000'); }
function presetDia2() { setColors('#f2e6a7', '#1a1a1a'); }
function presetDia3() { setColors('#dedede', '#1a1a1a'); }
function presetDia4() { setColors('#dedede', '#7a1121'); }
function presetDia5() { setColors('#4B1F1F', '#F5F5F2'); }
function presetDia6() { setColors('#3A2618', '#F5F5F2'); }
function presetDia7() { setColors('#3A2618', '#D4B15F'); }
function presetNoche() { setColors('#000000', '#ffffff'); }

function setColors(bg, text) {
  document.documentElement.style.setProperty('--bg-color', bg);
  document.documentElement.style.setProperty('--text-color', text);
  document.getElementById('bgColor').value = bg;
  document.getElementById('textColor').value = text;
}

bgColor.addEventListener('input', e => {
  document.documentElement.style.setProperty('--bg-color', e.target.value);
});

textColor.addEventListener('input', e => {
  document.documentElement.style.setProperty('--text-color', e.target.value);
});




/* ===============================
   DETECCIÓN DE ACORDES
================================ */

function isChordLine(line) {
  return /(\bDO|\bRE|\bMI|\bFA|\bSOL|\bLA|\bSI)[b#]?|\bCejillo\b|\bIntro\b|\bIntroducción\b/.test(line);
}

/* ===============================
   EXTRACCIÓN BASE (IDÉNTICA A LA ANTIGUA)
================================ */

function extraerTextoPreDesdeHTML(html) {
  const match = html.match(/<pre[^>]*>([\s\S]*?)<\/pre>/i);
  if (!match) return '';

  return match[1]
    .replace(/\r\n/g, '\n')
    .replace(/\r/g, '\n')
    .replace(/&nbsp;/g, ' ')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&amp;/g, '&');
}

/* ===============================
   PROCESAMIENTO
================================ */

function aplicarFiltroAcordes(lineas, conAcordes) {
  if (conAcordes) return lineas;
  return lineas.filter(l => !isChordLine(l));
}

function separarEnEstrofas(lineas) {
  const estrofas = [];
  let actual = [];

  lineas.forEach(linea => {
    if (linea.trim() === '') {
      if (actual.length) {
        estrofas.push(actual);
        actual = [];
      }
    } else {
      actual.push(linea);
    }
  });

  if (actual.length) estrofas.push(actual);
  return estrofas;
}

/* ===============================
   RENDER
================================ */

function renderContinuo(lineas) {
  return `
    <div class="letra-normal">
      ${lineas.map(l => l === '' ? '<br>' : `${l}<br>`).join('')}
    </div>
  `;
}

function renderPorEstrofas(estrofas) {
  return estrofas.map(e => `
    <div class="letra-normal">
      ${e.map(l => `${l}<br>`).join('')}
    </div>
  `).join('');
}

/* ===============================
   CARGA DE CANCIÓN (NÚCLEO)
================================ */

async function cargarCancion(ruta, conAcordes, porEstrofas) {
  try {
    const response = await fetch(ruta);
    if (!response.ok) throw new Error('No se pudo cargar ' + ruta);

    const html = await response.text();

    const textoPre = extraerTextoPreDesdeHTML(html);
    if (!textoPre.trim()) {
      console.warn('PRE vacío en:', ruta);
      return '<p>(Canción sin contenido)</p>';
    }

    const lineas = textoPre.split('\n');
    const filtradas = conAcordes ? lineas : lineas.filter(l => !isChordLine(l));

    const cuerpo = porEstrofas
      ? renderPorEstrofas(separarEnEstrofas(filtradas))
      : renderContinuo(filtradas);

    return cuerpo;

  } catch (err) {
    console.error(err);
    return '<p>Error al cargar la canción.</p>';
  }
}


/* ===============================
   PROYECCIÓN GENERAL
================================ */

async function iniciarProyeccion({ conAcordes, porEstrofas }) {
  document.getElementById('configuracion').style.display = 'none';

  const pantalla = document.getElementById('pantalla-proyector');
  pantalla.style.display = 'block';
  pantalla.innerHTML = '';

  for (const item of programa) {
    const htmlCancion = await cargarCancion(
      item.cancion,
      conAcordes,
      porEstrofas
    );

    const contenedor = document.createElement('div');
    contenedor.innerHTML = htmlCancion;
    pantalla.appendChild(contenedor);
  }
}

/* ===============================
   SELECTORES (BOTONES TOUCH)
================================ */

function configurarSelector(id) {
  const botones = document.querySelectorAll(`#${id} .btn`);
  botones.forEach(btn => {
    btn.addEventListener('click', () => {
      botones.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
}

configurarSelector('selector-acordes');
configurarSelector('selector-modo');

function proyectarDesdeSelectores() {
  const conAcordes =
    document.querySelector('#selector-acordes .btn.active').dataset.value === 'true';

  const porEstrofas =
    document.querySelector('#selector-modo .btn.active').dataset.value === 'true';

  iniciarProyeccion({ conAcordes, porEstrofas });
}

/* ===============================
   CONTROL DE TAMAÑO DE TEXTO
================================ */

let fontSize = 6;

function aplicarTamano() {
  document.documentElement.style.setProperty('--font-size', fontSize + 'vh');
}

function aumentarTexto() {
  fontSize += 0.5;
  aplicarTamano();
}

function disminuirTexto() {
  fontSize = Math.max(2, fontSize - 0.5);
  aplicarTamano();
}
</script>


<div id="controles-tamano">
  <button class="btn btn-outline-secondary" onclick="aumentarTexto()">A+</button>
  <button class="btn btn-outline-secondary" onclick="disminuirTexto()">A−</button>
</div>


</body>
</html>
