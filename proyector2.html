<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Proyector de letras - Cancionero Católico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/cancionero.css">

<style>
:root {
  --bg-color: #ffffff;
  --text-color: #000000;
  --font-size: 6vh;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
}

#configuracion {
  padding: 2rem;
  background-color: var(--bg-color);
  color: var(--text-color);
}

#configuracion .btn {
  color: var(--text-color);
  border-color: var(--text-color);
}

#configuracion .btn:hover {
  background-color: var(--text-color);
  color: var(--bg-color);
}

#pantalla-proyector {
  display: none;
  text-align: center;
  padding: 5vh 6vw;
  font-family: 'Atkinson Hyperlegible', system-ui, sans-serif;
  font-size: var(--font-size, 6vh);
  line-height: 1.25;
  white-space: pre-wrap;
}


#pantalla-proyector h2 {
  margin-bottom: 6rem;   /* ajusta a gusto */
}


button {
  margin: 0.25rem;
}

.letra-normal {
  margin-bottom: 6rem;
}



#controles-tamano {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 9999;
}

#controles-tamano button {
  display: block;
  margin-bottom: 0.3rem;
  font-size: 0.6rem;
  padding: 0.4rem 0.6rem;
  color: var(--text-color);
  border-color: var(--text-color);
}

/* Clases auxiliares para la proyección por estrofas */
.slide-flex {
    display: flex !important;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}
.estribillo-destacado {
    font-weight: bold;
}
.titulo-slide {
    font-size: 0.5em;
    opacity: 0.6;
    margin-bottom: 2vh;
    text-transform: uppercase;
}

</style>
</head>

<body>


<div id="configuracion" class="container text-center">
  <h1>Proyección de letras</h1>

  <div class="mt-4">
    <h5>Presets</h5>
    <button class="btn btn-outline-secondary" onclick="presetDia1()">Día 1</button>
    <button class="btn btn-outline-secondary" onclick="presetDia2()">Día 2</button>
    <button class="btn btn-outline-secondary" onclick="presetDia3()">Día 3</button>
    <button class="btn btn-outline-secondary" onclick="presetDia4()">Día 4</button>
 </div>
 <div>
    <button class="btn btn-outline-secondary" onclick="presetDia5()">Día 5</button>
    <button class="btn btn-outline-secondary" onclick="presetDia6()">Día 6</button>
    <button class="btn btn-outline-secondary" onclick="presetDia7()">Día 7</button>
    <button class="btn btn-outline-secondary" onclick="presetNoche()">Noche</button>
  </div>

  <div class="mt-4">
    <h5>Colores personalizados</h5>
    <label>Fondo: <input type="color" id="bgColor" value="#ffffff"></label>
    <label class="ms-3">Texto: <input type="color" id="textColor" value="#1a1a1a"></label>
  </div>

  <div class="mt-4">



  <div class="mt-4">
    <button class="btn btn-outline-secondary btn-lg" onclick="iniciarProyeccion()">Proyectar letras contínuas</button>
    <button class="btn btn-outline-secondary btn-lg" onclick="ProyeccionPorEstrofa()">Proyectar letras por estrofa</button>
  </div>
</div>

<div id="pantalla-proyector"></div>


<script>

    // 1. CARGA INICIAL DE DATOS
    const programa = JSON.parse(localStorage.getItem('programaMisa'));
    if (!programa || programa.length === 0) {
        alert('No hay programa guardado.');
        window.location.href = 'crear-programa.html';
    }

    // 2. UTILIDADES DE PROCESAMIENTO
    function isChordLine(line) {
        return /(\bDO|\bRE|\bMI|\bFA|\bSOL|\bLA|\bSI)[b#]?|\bCejillo\b|\bIntro\b|\bIntroducción\b/.test(line);
    }

    // Función limpia para extraer texto sin acordes
    function extraerLetraLimpia(htmlCrudo) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlCrudo, 'text/html');
        const pre = doc.querySelector('pre');
        if (!pre) return "";
        
        // Dividimos por líneas, filtramos acordes y quitamos spans
        return pre.innerHTML
            .split('\n')
            .filter(line => !isChordLine(line.replace(/<[^>]*>/g, '')))
            .join('\n')
            .replace(/<\/?span[^>]*>/gi, '');
    }

    async function obtenerDatosCancion(ruta) {
        try {
            const response = await fetch(ruta);
            const texto = await response.text();
            const doc = new DOMParser().parseFromString(texto, 'text/html');
            return {
                titulo: doc.querySelector('title')?.innerText || "Sin título",
                html: texto
            };
        } catch (e) {
            console.error("Error en fetch:", e);
            return null;
        }
    }

    // 3. MODO 1: PROYECCIÓN CONTINUA
    async function iniciarProyeccion() {
        const pantalla = document.getElementById('pantalla-proyector');
        document.getElementById('configuracion').style.display = 'none';
        pantalla.style.display = 'block';
        pantalla.classList.remove('slide-flex');
        pantalla.innerHTML = "Cargando canciones...";

        let acumulado = "";
        for (const item of programa) {
            const data = await obtenerDatosCancion(item.cancion);
            if (data) {
                const letra = extraerLetraLimpia(data.html).replace(/\n/g, '<br>');
                acumulado += `<div class="letra-normal"><h2>${data.titulo}</h2>${letra}</div><hr>`;
            }
        }
        pantalla.innerHTML = acumulado;
    }

    // 4. MODO 2: PROYECCIÓN POR ESTROFAS
    let slides = [];
    let slideActual = 0;

    async function ProyeccionPorEstrofa() {
        const pantalla = document.getElementById('pantalla-proyector');
        document.getElementById('configuracion').style.display = 'none';
        pantalla.innerHTML = "Procesando diapositivas...";
        
        slides = [];

        for (const item of programa) {
            const data = await obtenerDatosCancion(item.cancion);
            if (!data) continue;

            const letraLimpia = extraerLetraLimpia(data.html);
            
            // Separar por bloques (estrofas)
            const bloques = letraLimpia.split(/\n\s*\n/).filter(b => b.trim() !== "");

            // Diapositiva de título
            slides.push({ tipo: 'titulo', contenido: data.titulo });

            // Diapositivas de estrofas
            bloques.forEach(bloque => {
                slides.push({
                    tipo: 'estrofa',
                    titulo: data.titulo,
                    texto: bloque.trim(),
                    esEstribillo: /<b>/i.test(bloque)
                });
            });
        }

        if (slides.length > 0) {
            pantalla.style.display = 'flex';
            pantalla.classList.add('slide-flex');
            pantalla.onclick = avanzarSlide;
            slideActual = 0;
            mostrarSlide();
        } else {
            alert("No se pudieron cargar las letras.");
            location.reload();
        }
    }

    function mostrarSlide() {
        const pantalla = document.getElementById('pantalla-proyector');
        const s = slides[slideActual];

        if (s.tipo === 'titulo') {
            pantalla.innerHTML = `<h2 style="font-size: 10vh; margin:0;">${s.contenido}</h2>`;
        } else {
            const clase = s.esEstribillo ? 'estribillo-destacado' : '';
            // Quitamos etiquetas <b> para el texto final, los saltos \n a <br>
            const textoFinal = s.texto.replace(/<\/?b>/gi, '').replace(/\n/g, '<br>');
            pantalla.innerHTML = `
                <div class="titulo-slide">${s.titulo}</div>
                <div class="${clase}" style="white-space: normal;">${textoFinal}</div>
            `;
        }
    }

    function avanzarSlide() {
        if (slideActual < slides.length - 1) {
            slideActual++;
            mostrarSlide();
        } else {
            if(confirm("Fin del programa. ¿Salir?")) location.reload();
        }
    }

    // Eventos de Teclado
    window.addEventListener('keydown', (e) => {
        if (document.getElementById('pantalla-proyector').style.display !== 'none') {
            if (e.key === "ArrowRight" || e.key === " ") avanzarSlide();
            if (e.key === "ArrowLeft" && slideActual > 0) { slideActual--; mostrarSlide(); }
            if (e.key === "Escape") location.reload();
        }
    });





    // 5. COLORES Y TAMAÑO
    function setColors(bg, text) {
        document.documentElement.style.setProperty('--bg-color', bg);
        document.documentElement.style.setProperty('--text-color', text);
        document.getElementById('bgColor').value = bg;
        document.getElementById('textColor').value = text;
    }
    // Tus presets
    function presetDia1() { setColors('#ffffff', '#000000'); }
    function presetDia2() { setColors('#f2e6a7', '#1a1a1a'); }
    function presetDia3() { setColors('#dedede', '#1a1a1a'); }
    function presetDia4() { setColors('#dedede', '#7a1121'); }
    function presetDia5() { setColors('#4B1F1F', '#F5F5F2'); }
    function presetDia6() { setColors('#3A2618', '#F5F5F2'); }
    function presetDia7() { setColors('#3A2618', '#D4B15F'); }
    function presetNoche() { setColors('#000000', '#ffffff'); }

    const bgColor = document.getElementById('bgColor');
    const textColor = document.getElementById('textColor');
    
    if(bgColor) bgColor.addEventListener('input', e => document.documentElement.style.setProperty('--bg-color', e.target.value));
    if(textColor) textColor.addEventListener('input', e => document.documentElement.style.setProperty('--text-color', e.target.value));



    // ======================================================
    // TAMAÑO DE TEXTO
    // ======================================================
    let fontSize = 6;
    function aplicarTamano() { document.documentElement.style.setProperty('--font-size', fontSize + 'vh'); }
    function aumentarTexto() { fontSize += 0.5; aplicarTamano(); }
    function disminuirTexto() { fontSize = Math.max(2, fontSize - 0.5); aplicarTamano(); }
</script>


<div id="controles-tamano">
  <button class="btn btn-outline-secondary" onclick="aumentarTexto()">A+</button>
  <button class="btn btn-outline-secondary" onclick="disminuirTexto()">A−</button>
</div>


</body>
</html>
