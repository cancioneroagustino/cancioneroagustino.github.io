<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Proyector de letras - Cancionero Católico</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
<link href="./css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/cancionero.css">

<style>
:root {
  --bg-color: #ffffff;
  --text-color: #000000;
  --font-size: 6vh;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
}

#configuracion {
  padding: 2rem;
  background-color: var(--bg-color);
  color: var(--text-color);
}

#configuracion .btn {
  color: var(--text-color);
  border-color: var(--text-color);
}

#configuracion .btn:hover {
  background-color: var(--text-color);
  color: var(--bg-color);
}

#pantalla-proyector {
    display: none; /* Se cambia a flex en JS */
    text-align: center;
    width: 100%;
    min-height: 100vh; /* Ocupa toda la altura */
    padding: 5vh 6vw;
    font-family: 'Atkinson Hyperlegible', system-ui, sans-serif;
    font-size: var(--font-size, 6vh);
    line-height: 1.25;
    cursor: pointer; /* Indica que se puede hacer clic */
    user-select: none; /* Evita que se seleccione el texto al hacer clics rápidos */
    touch-action: manipulation; /* Optimiza para toques en móvil */
}


#pantalla-proyector h2 {
  margin-bottom: 6rem;   /* ajusta a gusto */
}


button {
  margin: 0.25rem;
}

.letra-normal {
  margin-bottom: 6rem;
}



#controles-tamano {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 9999;
}

#controles-tamano button {
  display: block;
  margin-bottom: 0.3rem;
  font-size: 0.6rem;
  padding: 0.4rem 0.6rem;
  color: var(--text-color);
  border-color: var(--text-color);
}

/* Clases auxiliares para la proyección por estrofas */
.slide-flex {
    display: flex !important;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}
.estribillo-destacado {
    font-weight: bold;
}
.titulo-slide {
    display: none;
}

</style>
</head>

<body>


<div id="configuracion" class="container text-center">
  <h1>Proyección de letras</h1>

  <div class="mt-4">
    <h5>Presets</h5>
    <button class="btn btn-outline-secondary" onclick="presetDia1()">Día 1</button>
    <button class="btn btn-outline-secondary" onclick="presetDia2()">Día 2</button>
    <button class="btn btn-outline-secondary" onclick="presetDia3()">Día 3</button>
    <button class="btn btn-outline-secondary" onclick="presetDia4()">Día 4</button>
 </div>
 <div>
    <button class="btn btn-outline-secondary" onclick="presetDia5()">Día 5</button>
    <button class="btn btn-outline-secondary" onclick="presetDia6()">Día 6</button>
    <button class="btn btn-outline-secondary" onclick="presetDia7()">Día 7</button>
    <button class="btn btn-outline-secondary" onclick="presetNoche()">Noche</button>
  </div>

  <div class="mt-4">
    <h5>Colores personalizados</h5>
    <label>Fondo: <input type="color" id="bgColor" value="#ffffff"></label>
    <label class="ms-3">Texto: <input type="color" id="textColor" value="#1a1a1a"></label>
  </div>


  <div class="mt-4">
    <button class="btn btn-outline-secondary btn-lg" onclick="iniciarProyeccion()">Proyectar letras contínuas</button>
    <button class="btn btn-outline-secondary btn-lg" onclick="ProyeccionPorEstrofa()">Proyectar letras por estrofa</button>
  </div>
</div>

<div id="pantalla-proyector"></div>


<script>

// 1. Verificación inmediata de datos
const programaMisa = JSON.parse(localStorage.getItem('programaMisa'));
console.log("Datos en LocalStorage:", programaMisa);

if (!programaMisa || programaMisa.length === 0) {
    alert("No hay programa. Redirigiendo...");
    window.location.href = 'crear-programa.html';
}

// 2. Variables de estado globales
let diapositivas = [];
let indiceActual = 0;

// 3. Función de limpieza ultra-segura
function limpiarTexto(html) {
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const pre = temp.querySelector('pre');
    if (!pre) return "";

    // Expresión regular para detectar líneas de acordes (incluye variantes comunes)
    const esAcorde = (linea) => /(\bDO|\bRE|\bMI|\bFA|\bSOL|\bLA|\bSI)[b#]?|\bCejillo\b|\bIntro\b/.test(linea);

    return pre.innerHTML
        .split('\n')
        .map(l => l.replace(/<[^>]*>/g, '')) // Quitar Spans/Bolds de la línea
        .filter(l => !esAcorde(l))           // Quitar si es acorde
        .join('\n')
        .trim();
}

// 4. EL MOTOR DE CARGA 
async function cargarTodoElPrograma() {
    diapositivas = [];

    for (const item of programaMisa) {
        try {
            const res = await fetch(item.cancion);
            const html = await res.text();
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const titulo = doc.querySelector('title')?.innerText || "Sin título";
            
            // 1. Extraer bloques manteniendo el formato original para detectar <b>
            const pre = doc.querySelector('pre');
            if (!pre) continue;

            // Limpiamos acordes pero mantenemos etiquetas <b><span> para el análisis
            let lineasLimpias = pre.innerHTML.split('\n')
                .filter(l => !isChordLine(l.replace(/<[^>]*>/g, '')))
                .join('\n');

            // 2. Dividir por estrofas (doble salto de línea)
            let bloquesRaw = lineasLimpias.split(/\n\s*\n/).filter(b => b.trim() !== "");

            // 3. Identificar cuáles son estribillos
            let bloquesProcesados = bloquesRaw.map(b => {
                return {
                    texto: b.replace(/<\/?span[^>]*>/gi, '').trim(),
                    esEstribillo: /<b>/i.test(b)
                };
            });

            // --- LÓGICA DE INTERCALADO ---
            const estribillos = bloquesProcesados.filter(b => b.esEstribillo);
            
            // Diapositiva de Título
            diapositivas.push({ tipo: 'titulo', contenido: titulo });

            if (estribillos.length === 1) {
                // Si hay exactamente UN estribillo, lo intercalamos
                const elEstribillo = estribillos[0];
                bloquesProcesados.forEach(bloque => {
                    if (!bloque.esEstribillo) {
                        diapositivas.push({ tipo: 'estrofa', texto: bloque.texto, esEstribillo: false });
                        diapositivas.push({ tipo: 'estrofa', texto: elEstribillo.texto, esEstribillo: true });
                    }
                });
            } else {
                // Si hay varios o ninguno, los ponemos en orden natural
                bloquesProcesados.forEach(bloque => {
                    diapositivas.push({ 
                        tipo: 'estrofa', 
                        texto: bloque.texto, 
                        esEstribillo: bloque.esEstribillo 
                    });
                });
            }

        } catch (err) {
            console.error("Error cargando canción:", err);
        }
    }
}

function renderizarSlide() {
    const pantalla = document.getElementById('pantalla-proyector');
    const d = diapositivas[indiceActual];
    
    // Limpieza final de etiquetas para mostrar solo texto
    const textoParaMostrar = d.texto ? d.texto.replace(/<\/?b>/gi, '').replace(/\n/g, '<br>') : "";

    if (d.tipo === 'titulo') {
        pantalla.innerHTML = `<h2 style="font-size: 8vh; margin:0;">${d.contenido}</h2>`;
    } else {
        const estiloEstribillo = d.esEstribillo ? 'font-weight: bold;' : '';
        pantalla.innerHTML = `
            <div style="${estiloEstribillo} width: 100%;">${textoParaMostrar}</div>
        `;
    }
}

// 5. LANZADORES DE MODO
async function iniciarProyeccion() {
    await cargarTodoElPrograma();
    const pantalla = document.getElementById('pantalla-proyector');
    document.getElementById('configuracion').style.display = 'none';
    
    // Modo Continuo: Juntamos todo en un solo bloque
    pantalla.classList.remove('slide-flex');
    pantalla.style.display = 'block';
    pantalla.style.textAlign = 'center';
    
    let htmlFinal = "";
    diapositivas.forEach(d => {
        if(d.tipo === 'titulo') htmlFinal += `<h2 style="margin-top:10vh">${d.contenido}</h2>`;
        else htmlFinal += `<p class="letra-normal">${d.texto.replace(/\n/g, '<br>')}</p>`;
    });
    pantalla.innerHTML = htmlFinal;
}

async function ProyeccionPorEstrofa() {
    await cargarTodoElPrograma();
    if (diapositivas.length === 0) {
        alert("Error: No se pudieron procesar las letras.");
        return;
    }
    document.getElementById('configuracion').style.display = 'none';
    const pantalla = document.getElementById('pantalla-proyector');
    pantalla.classList.add('slide-flex');
    pantalla.style.display = 'flex';
    
    indiceActual = 0;
    renderizarSlide();
}




// --- SISTEMA DE NAVEGACIÓN UNIVERSAL ---

function avanzar() {
    if (indiceActual < diapositivas.length - 1) {
        indiceActual++;
        renderizarSlide();
    } else {
        if (confirm("Fin del programa. ¿Volver al inicio?")) location.reload();
    }
}

function retroceder() {
    if (indiceActual > 0) {
        indiceActual--;
        renderizarSlide();
    }
}

// A. Control por Teclado (Soporte total)
window.onkeydown = (e) => {
    // Si la pantalla de proyección está visible
    if (document.getElementById('pantalla-proyector').style.display !== 'none') {
        switch(e.key) {
            case "ArrowRight":
            case "Enter":
            case " ": // Espacio
                e.preventDefault(); // Evita que la página haga scroll con el espacio
                avanzar();
                break;
            case "ArrowLeft":
            case "Backspace":
                e.preventDefault();
                retroceder();
                break;
            case "Escape":
                location.reload();
                break;
        }
    }
};

// B. Control por Mouse (Click izquierdo avanza, Click derecho retrocede)
document.getElementById('pantalla-proyector').onmousedown = (e) => {
    if (e.button === 0) { // Click izquierdo
        avanzar();
    } else if (e.button === 2) { // Click derecho
        e.preventDefault();
        retroceder();
    }
};

// Evitar que el menú contextual del click derecho moleste
document.getElementById('pantalla-proyector').oncontextmenu = (e) => e.preventDefault();

// C. Control para Móvil (Toque a la derecha o izquierda)
let touchStartX = 0;
document.getElementById('pantalla-proyector').addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
}, false);

document.getElementById('pantalla-proyector').addEventListener('touchend', (e) => {
    let touchEndX = e.changedTouches[0].screenX;
    let pantallaAncho = window.innerWidth;
    
    // Si el toque fue en el tercio izquierdo de la pantalla, retrocede. 
    // Si fue en el resto, avanza.
    if (touchEndX < pantallaAncho / 3) {
        retroceder();
    } else {
        avanzar();
    }
}, false);





    // 5. COLORES Y TAMAÑO
    function setColors(bg, text) {
        document.documentElement.style.setProperty('--bg-color', bg);
        document.documentElement.style.setProperty('--text-color', text);
        document.getElementById('bgColor').value = bg;
        document.getElementById('textColor').value = text;
    }
    // Tus presets
    function presetDia1() { setColors('#ffffff', '#000000'); }
    function presetDia2() { setColors('#f2e6a7', '#1a1a1a'); }
    function presetDia3() { setColors('#dedede', '#1a1a1a'); }
    function presetDia4() { setColors('#dedede', '#7a1121'); }
    function presetDia5() { setColors('#4B1F1F', '#F5F5F2'); }
    function presetDia6() { setColors('#3A2618', '#F5F5F2'); }
    function presetDia7() { setColors('#3A2618', '#D4B15F'); }
    function presetNoche() { setColors('#000000', '#ffffff'); }

    const bgColor = document.getElementById('bgColor');
    const textColor = document.getElementById('textColor');
    
    if(bgColor) bgColor.addEventListener('input', e => document.documentElement.style.setProperty('--bg-color', e.target.value));
    if(textColor) textColor.addEventListener('input', e => document.documentElement.style.setProperty('--text-color', e.target.value));



    // ======================================================
    // TAMAÑO DE TEXTO
    // ======================================================
    let fontSize = 6;
    function aplicarTamano() { document.documentElement.style.setProperty('--font-size', fontSize + 'vh'); }
    function aumentarTexto() { fontSize += 0.5; aplicarTamano(); }
    function disminuirTexto() { fontSize = Math.max(2, fontSize - 0.5); aplicarTamano(); }
</script>


<div id="controles-tamano">
  <button class="btn btn-outline-secondary" onclick="aumentarTexto()">A+</button>
  <button class="btn btn-outline-secondary" onclick="disminuirTexto()">A−</button>
</div>


</body>
</html>
